!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.gaia=e():t.gaia=e()}(self,()=>(()=>{"use strict";var t={7:t=>{var e,r="object"==typeof Reflect?Reflect:null,s=r&&"function"==typeof r.apply?r.apply:function(t,e,r){return Function.prototype.apply.call(t,e,r)};e=r&&"function"==typeof r.ownKeys?r.ownKeys:Object.getOwnPropertySymbols?function(t){return Object.getOwnPropertyNames(t).concat(Object.getOwnPropertySymbols(t))}:function(t){return Object.getOwnPropertyNames(t)};var n=Number.isNaN||function(t){return t!=t};function i(){i.init.call(this)}t.exports=i,t.exports.once=function(t,e){return new Promise(function(r,s){function n(r){t.removeListener(e,i),s(r)}function i(){"function"==typeof t.removeListener&&t.removeListener("error",n),r([].slice.call(arguments))}y(t,e,i,{once:!0}),"error"!==e&&function(t,e){"function"==typeof t.on&&y(t,"error",e,{once:!0})}(t,n)})},i.EventEmitter=i,i.prototype._events=void 0,i.prototype._eventsCount=0,i.prototype._maxListeners=void 0;var o=10;function a(t){if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t)}function c(t){return void 0===t._maxListeners?i.defaultMaxListeners:t._maxListeners}function h(t,e,r,s){var n,i,o,h;if(a(r),void 0===(i=t._events)?(i=t._events=Object.create(null),t._eventsCount=0):(void 0!==i.newListener&&(t.emit("newListener",e,r.listener?r.listener:r),i=t._events),o=i[e]),void 0===o)o=i[e]=r,++t._eventsCount;else if("function"==typeof o?o=i[e]=s?[r,o]:[o,r]:s?o.unshift(r):o.push(r),(n=c(t))>0&&o.length>n&&!o.warned){o.warned=!0;var u=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");u.name="MaxListenersExceededWarning",u.emitter=t,u.type=e,u.count=o.length,h=u,console&&console.warn&&console.warn(h)}return t}function u(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function l(t,e,r){var s={fired:!1,wrapFn:void 0,target:t,type:e,listener:r},n=u.bind(s);return n.listener=r,s.wrapFn=n,n}function p(t,e,r){var s=t._events;if(void 0===s)return[];var n=s[e];return void 0===n?[]:"function"==typeof n?r?[n.listener||n]:[n]:r?function(t){for(var e=new Array(t.length),r=0;r<e.length;++r)e[r]=t[r].listener||t[r];return e}(n):d(n,n.length)}function f(t){var e=this._events;if(void 0!==e){var r=e[t];if("function"==typeof r)return 1;if(void 0!==r)return r.length}return 0}function d(t,e){for(var r=new Array(e),s=0;s<e;++s)r[s]=t[s];return r}function y(t,e,r,s){if("function"==typeof t.on)s.once?t.once(e,r):t.on(e,r);else{if("function"!=typeof t.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof t);t.addEventListener(e,function n(i){s.once&&t.removeEventListener(e,n),r(i)})}}Object.defineProperty(i,"defaultMaxListeners",{enumerable:!0,get:function(){return o},set:function(t){if("number"!=typeof t||t<0||n(t))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+t+".");o=t}}),i.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},i.prototype.setMaxListeners=function(t){if("number"!=typeof t||t<0||n(t))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+t+".");return this._maxListeners=t,this},i.prototype.getMaxListeners=function(){return c(this)},i.prototype.emit=function(t){for(var e=[],r=1;r<arguments.length;r++)e.push(arguments[r]);var n="error"===t,i=this._events;if(void 0!==i)n=n&&void 0===i.error;else if(!n)return!1;if(n){var o;if(e.length>0&&(o=e[0]),o instanceof Error)throw o;var a=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw a.context=o,a}var c=i[t];if(void 0===c)return!1;if("function"==typeof c)s(c,this,e);else{var h=c.length,u=d(c,h);for(r=0;r<h;++r)s(u[r],this,e)}return!0},i.prototype.addListener=function(t,e){return h(this,t,e,!1)},i.prototype.on=i.prototype.addListener,i.prototype.prependListener=function(t,e){return h(this,t,e,!0)},i.prototype.once=function(t,e){return a(e),this.on(t,l(this,t,e)),this},i.prototype.prependOnceListener=function(t,e){return a(e),this.prependListener(t,l(this,t,e)),this},i.prototype.removeListener=function(t,e){var r,s,n,i,o;if(a(e),void 0===(s=this._events))return this;if(void 0===(r=s[t]))return this;if(r===e||r.listener===e)0===--this._eventsCount?this._events=Object.create(null):(delete s[t],s.removeListener&&this.emit("removeListener",t,r.listener||e));else if("function"!=typeof r){for(n=-1,i=r.length-1;i>=0;i--)if(r[i]===e||r[i].listener===e){o=r[i].listener,n=i;break}if(n<0)return this;0===n?r.shift():function(t,e){for(;e+1<t.length;e++)t[e]=t[e+1];t.pop()}(r,n),1===r.length&&(s[t]=r[0]),void 0!==s.removeListener&&this.emit("removeListener",t,o||e)}return this},i.prototype.off=i.prototype.removeListener,i.prototype.removeAllListeners=function(t){var e,r,s;if(void 0===(r=this._events))return this;if(void 0===r.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==r[t]&&(0===--this._eventsCount?this._events=Object.create(null):delete r[t]),this;if(0===arguments.length){var n,i=Object.keys(r);for(s=0;s<i.length;++s)"removeListener"!==(n=i[s])&&this.removeAllListeners(n);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(e=r[t]))this.removeListener(t,e);else if(void 0!==e)for(s=e.length-1;s>=0;s--)this.removeListener(t,e[s]);return this},i.prototype.listeners=function(t){return p(this,t,!0)},i.prototype.rawListeners=function(t){return p(this,t,!1)},i.listenerCount=function(t,e){return"function"==typeof t.listenerCount?t.listenerCount(e):f.call(t,e)},i.prototype.listenerCount=f,i.prototype.eventNames=function(){return this._eventsCount>0?e(this._events):[]}}},e={};function r(s){var n=e[s];if(void 0!==n)return n.exports;var i=e[s]={exports:{}};return t[s](i,i.exports,r),i.exports}r.d=(t,e)=>{for(var s in e)r.o(e,s)&&!r.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:e[s]})},r.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var s={};r.r(s),r.d(s,{Aura:()=>v,Gaia:()=>P,GaiaAura:()=>N,HttpAura:()=>$,Sprite:()=>T,Vibe:()=>M});var n=r(7);class i extends n.EventEmitter{playing;name;ensemble;constructor(t){super(),this.playing=!1,this.name=t,this.ensemble=void 0}play(){return this.playing=!0,this}pause(){return this.playing=!1,this}let(t,e){const r=this[t];return r===e||(this[t]=e,this.emit("propertyChanged",t,r,e)),this}emit(t,...e){return super.emit(t,...e),this.ensemble?.emit(t,...e),this}notify(t,...e){const r=`[${this.constructor.name}]`,s=(new Date).toISOString();console.log(`${s} ${r} ${t}:`,...e),this.emit(t,...e)}}class o extends i{players;constructor(){super(),this.players=new Map}[Symbol.iterator](){return this.players.values()}add(t,e){if(this.players.has(t))throw new Error(`A Player with the name "${t}" is already in this Ensemble.`);return this.players.set(t,e),e.let("name",t),e.let("ensemble",this),this}get(t,e=!1){let r=this.players.get(t);return!r&&e&&(r=new o,this.playing&&r.play(),this.add(t,r)),r}has(t){return this.players.has(t)}remove(t){const e=this.players.get(t);return!!e&&(e.let("ensemble",void 0),e.let("name",void 0),this.players.delete(t))}rotate(t=void 0){if(!t&&this.players.size>0){const e=this.players.values().next().value;t=e?.name}const e=this.get(t);return e&&(this.remove(t),this.add(t,e)),e}sort(t,e=void 0){const r=Array.from(this.players.entries()).sort(t),s=void 0!==e?r.splice(e):[];this.players.clear();for(const[t,e]of r)this.players.set(t,e);return s}descendants(t=!1){const e=[];for(const r of this.players.values())r instanceof o?(t&&e.push(r),e.push(...r.descendants(t))):e.push(r);return e}play(){if(!this.playing){for(const t of this.players.values())"function"!=typeof t.play||t.playing||t.play();this.let("playing",!0)}}pause(){if(this.playing){for(const t of this.players.values())"function"==typeof t.pause&&t.playing&&t.pause();this.let("playing",!1)}}}class a extends i{_emitter;_event;_rawListener;_boundListener;_opts;_attached;constructor(t,e,r,s={}){if(super(),"string"!=typeof e)throw new TypeError("event must be a string");if("function"!=typeof r)throw new TypeError("listener must be a function");this._emitter=t,this._event=e,this._rawListener=r,this._boundListener=r.bind(this),this._opts=s,this._attached=!1}get emitter(){return this._emitter}get event(){return this._event}get boundListener(){return this._boundListener}get attached(){return this._attached}set attached(t){this._attached=t}play(){if(this.attached)return;const{emitter:t,event:e,boundListener:r,_opts:s}=this;s.prepend&&"function"==typeof t.prependListener?t.prependListener(e,r):a.addListener(t,e,r,s),this.attached=!0}pause(){if(!this.attached)return;const{emitter:t,event:e,boundListener:r,_opts:s}=this;a.removeListener(t,e,r,s),this.attached=!1}promise(t=1e3,e=t=>void 0!==t){if("number"!=typeof t||isNaN(t))throw new TypeError("timeoutMillis must be a number");return new Promise((r,s)=>{let n;const i=(...t)=>{try{const s=this._rawListener(...t);if(!e(s))return;a.removeListener(this._emitter,this._event,i,this._opts),clearTimeout(n),r(s)}catch(t){a.removeListener(this._emitter,this._event,i,this._opts),clearTimeout(n),s(t)}};a.addListener(this._emitter,this._event,i,this._opts),t>0&&(n=setTimeout(()=>{a.removeListener(this._emitter,this._event,i,this._opts),s(new Error(`Timeout waiting for event '${this.event}'`))},t))})}static addListener(t,e,r,s={}){if("function"==typeof t.addEventListener)t.addEventListener(e,r,s);else if("function"==typeof t.prependListener&&s.prepend)t.prependListener(e,r);else if("function"==typeof t.on)t.on(e,r);else{if("function"!=typeof t.addListener)throw new Error("Unsupported emitter interface for addListener");t.addListener(e,r)}}static removeListener(t,e,r,s={}){if("function"==typeof t.removeEventListener)t.removeEventListener(e,r,s);else if("function"==typeof t.off)t.off(e,r);else{if("function"!=typeof t.removeListener)throw new Error("Unsupported emitter interface for removeListener");t.removeListener(e,r)}}}class c{constructor(t=void 0,e=void 0,r={}){this._parent=t,this._name=e,this._children=r}get parent(){return this._parent}set parent(t){this._parent=t}get name(){return this._name}let(t,e){return this[t]=e,this}letChild(t,e){return this._children[t]=e,e.parent=this,e._name=t,this}get(...t){return this.ancestors().which(e=>t.every(t=>void 0!==e[t])).then(e=>e[t[0]]).what()}getChild(...t){let e=this;for(const r of t)if(e=e?._children?.[r],!e)break;return e}resolve(t){return"string"==typeof t?this.get(t):t}forget(t){return delete this[t],this}isLeaf(){return void 0===this.children().what()}isRoot(){return void 0===this.parent}children(){return y.as(Object.values(this._children))}root(){return this.parent?this.parent.root():this}ancestors(){return y.along(this,t=>t.parent)}}class h extends c{constructor(t=void 0,e=void 0){super(t,void 0),this._last=e,this._length=t?t._length+1:void 0!==e?1:0}static of(...t){return(new h).along(t)}get prev(){return this._parent}get last(){return this._last}get length(){return this._length}let(t,e){throw new Error("A Path is immutable!")}letChild(t,e){throw new Error("A Path is immutable!")}forget(t){throw new Error("A Path is immutable!")}isEmpty(){return 0==this._length}add(t){return new h(0<this.length?this:void 0,t)}along(t){let e=this;for(let r of t)e=e.add(r);return e}across(t){const e=this,r=new y;return r[Symbol.iterator]=function*(){for(let r of t)yield e.add(r)},r}toArray(t=this.length,e=t=>t){const r=new Array(t);let s=this;for(;0<t;)r[t-1]=e(s.last),s=s.prev,t--;return r}}class u{[Symbol.asyncIterator](){throw"abstract method!"}static of(...t){const e=new u;return e[Symbol.asyncIterator]=async function*(){for(const e of t)yield await e},e}static as(t){let e;return void 0===t?u.of():t instanceof u?t:(t[Symbol.iterator]||t[Symbol.asyncIterator]?(e=new u,e[Symbol.asyncIterator]=async function*(){for(const e of t)yield e}):(e=new u,e[Symbol.asyncIterator]=async function*(){yield await t}),e)}async toArray(){const t=[];for await(const e of this)t.push(e);return t}async equals(t){return u.equal(this,t)}static along(t,e){const r=new u;return r[Symbol.asyncIterator]=async function*(){let r=t;for(;null!=r;)yield r,r=await e(r)},r}static async equal(t,e){if("string"==typeof t||!y.isIterable(t)&&!u.isAsyncIterable(t)||"string"==typeof e||!y.isIterable(e)&&!u.isAsyncIterable(e))return t===e;{const r=u.as(t)[Symbol.asyncIterator](),s=u.as(e)[Symbol.asyncIterator]();for(;;){const t=await r.next(),e=await s.next();if(t.done||e.done)return t.done===e.done;if(!await u.equal(t.value,e.value))return!1}}}static isAsyncIterable(t){return null!=t&&"function"==typeof t[Symbol.asyncIterator]}if(t=t=>void 0!==t){const e=this,r=new u;return r[Symbol.asyncIterator]=async function*(){let r=0;for await(const s of e)await t(s,r++)&&(yield s)},r}sthen(t){const e=this,r=new u;return r[Symbol.asyncIterator]=async function*(){let r=0;for await(const s of e)yield await t(s,r++)},r}else(t=void 0){return void 0===t?u.else(this):u.else([this,u.as(t)])}static else(t){const e=new u;return e[Symbol.asyncIterator]=async function*(){for await(const e of u.as(t)){const t=u.as(e);for await(const e of t)yield e}},e}which(t){return this.if(t)}when(t,e=!0,r=e){return u.when(this,t,e,r)}static when(t,e,r=!0,s=r){if(void 0===e){const e={};return e[Symbol.asyncIterator]=async function*(){for await(const e of t)yield e},u.as(e)}if("number"==typeof e){const t=e;e=(e,r)=>r===t}const n=new u;return n[Symbol.asyncIterator]=r?async function*(){let r=0,n=!1;for await(const i of t)n?yield i:await e(i,r)&&(n=!0,s&&(yield i)),r++}:async function*(){let r=0,n=!1;for await(const i of t){if(n)break;await e(i,r)?(n=!0,s&&(yield i)):yield i,r++}},n}match(t=void 0){return void 0===t?u.match(this):u.match(this,u.as(t))}static match(...t){const e=new u,r=t.map(t=>u.as(t));return e[Symbol.asyncIterator]=async function*(){const t=r.map(t=>t[Symbol.asyncIterator]());for(;;){const e=await Promise.all(t.map(t=>t.next()));if(e.some(t=>t.done))break;yield e.map(t=>t.value)}},e}each(t=void 0){if(void 0===t)return u.each(...this);const e=this,r=new u;return r[Symbol.asyncIterator]=async function*(){for await(const r of e)for await(const e of u.as(t))yield[r,e]},r}static each(...t){const e=t.map(t=>u.as(t));return d.as(t=>{if(t.length>=e.length)return u.of();const r=e[t.length],s=new u;return s[Symbol.asyncIterator]=async function*(){for await(const e of r)yield t.add(e)},s})}self(){return u.self(this)}static self(t){const e=u.as(t),r=new u;return r[Symbol.asyncIterator]=async function*(){for(;;)yield e},r}async what(t,e){return u.what(this,t,e)}static async what(t,e,r){const s=u.as(t);if(e){let t=void 0!==r;for await(const n of s)t?r=await e(r,n):(r=n,t=!0);return r}for await(const t of s)return t}}class l{static matches(t,e){if("function"==typeof e)try{return e(t)}catch(t){return!1}if(null==t)return!1;if(t===e)return!0;if(t instanceof Error)return this.matches(t.constructor.name,e)||this.matches(t.statusCode,e)||this.matches(t.message,e);if("string"==typeof t){if("string"==typeof e)return t.includes(e);if(e instanceof RegExp)return e.test(t)}return!1}}class p extends Error{constructor(t,e="Operation timed out",r){super(e),this.millis=t,this.name=this.constructor.name,r&&(this.cause=r)}}class f{static of(...t){const e=t.slice(0,-1),r=t.at(-1);return f.as(async(...t)=>await u.equal(e,t)?r:void 0)}static as(t){if(t instanceof f)return t;if("function"!=typeof t){const e=t;t=async()=>e}const e=async(...e)=>await t(...e);return Object.setPrototypeOf(e,f.prototype),e.what=t.bind(e),e}static retype(t,e){return Object.setPrototypeOf(t,Object.getPrototypeOf(e)),t}if(t=async t=>void 0!==t,e=void 0){return f.retype(f.if(t,this,e),this)}static if(t,e,r=void 0){return f.as(async(...s)=>{if(await t(...s))return await e(...s);throw r})}sthen(...t){return f.retype(f.sthen(this,...t),this)}static sthen(...t){return f.as(async e=>{let r=e;for(let e of t)r=await e(r);return r})}else(t,e=void 0){return t=f.as(t),f.retype(async(...r)=>{let s;try{s=await this(...r)}catch(s){if(!e||l.matches(s,e))return await t(...r,s);throw s}return void 0===s?await t(...r):s},this)}which(t=async t=>void 0!==t,e=void 0){return f.retype(f.which(this,t,e),this)}static which(t,e=async t=>void 0!==t,r=void 0){return f.as(async(...s)=>{const n=await t(...s);if(await e(n,...s))return n;if(void 0!==r)throw r})}when(t,e,r,s=void 0,n=!0){return f.when(t,this,e,r,s,n)}static when(t,e,r,s,n,i=!0){const o=f.as(async(...o)=>(i||e(...o),new Promise((o,a)=>{let c;const h=async(...s)=>{try{await t(...s,r)&&(u(),e.stopped=!i,i?o(await e(...s,r)):o())}catch(t){u(),a(t)}},u=()=>{c&&clearTimeout(c),"function"==typeof r.off?r.off(s,h):"function"==typeof r.removeEventListener&&r.removeEventListener(s,h)};if("function"==typeof r.on)r.on(s,h);else{if("function"!=typeof r.addEventListener)throw new Error("Unsupported emitter type");r.addEventListener(s,h)}n>0&&(c=setTimeout(()=>{u(),a(new p(`Event "${s}" timed out after ${n}ms`))},n))})));return Object.defineProperty(o,"stopped",{get:()=>e.stopped,set:t=>e.stopped=t}),o}match(...t){return f.retype(f.match(this,...t),this)}static match(...t){const e=t.length<2?async e=>[e,await t[0](e)]:async e=>{const r=[];for(let s of t)r.push(await s(e));return r};return f.as(e)}each(t){return f.retype(async(...e)=>await u.as(await this(...e)).which().sthen(t).which().else().toArray(),this)}static each(...t){return f.as(async e=>{const r=e instanceof h?e:h.of(e);return r.length>t.length?y.of():r.across(await u.as(await f.as(t[r.length-1])(r.last)).which().toArray()).which()})}self(...t){return f.retype(f.self(this,...t),this)}static self(t,...e){let r;if(0===e.length)return r=async e=>e.across(await u.as(await t(e.last)).which().toArray()),f.as(r);if("number"!=typeof e[0]){const[r,s]=e;return f.nominal(t,r,s)}if(1===e.length)return f.within(e[0],t);if(2===e.length){const[r,s]=e;return f.partial(t,r,s)}return f.retry(t,...e)}static partial(t,e,r){return f.as(async(...s)=>t(...s.slice(0,e),r,...s.slice(e)))}static nominal(t,e,r){let s;return s=void 0===e?async(...e)=>{const s=await t(...e);if(void 0===s)return;const n={};return n[r]=s,n}:async s=>{const n=await u.as("string"==typeof e?[e]:e).sthen(t=>"string"==typeof t?s[t]:t).toArray(),i=await("string"==typeof t?s[t]:t)(...n);return void 0!==r?(s[r]=i,s):i},f.as(s)}static within(t,e,r=new p(`Operation timed out after ${t}ms`)){return f.as(async s=>{let n;try{return await Promise.race([e(s),new Promise((e,s)=>{n=setTimeout(()=>s(r),t)})])}finally{clearTimeout(n)}})}static retry(t,e=1/0,r=100,s=1,n=1/0){let i=!1;const o=f.as(o=>{let a=0,c=null;return new Promise((h,u)=>{const l=async()=>{if(i)return u(new Error("Retry stopped by user"));try{const e=await t(o);h(e)}catch(t){if(c=t,a++,a<e&&!i){const t=Math.min(r*s**(a-1),n);setTimeout(l,t)}else u(i?new Error("Retry stopped by user"):c)}};l()})});return Object.defineProperty(o,"stopped",{get:()=>i,set:t=>{i=Boolean(t)}}),o}}class d{static of(...t){const e=t.slice(0,-1),r=t.at(-1);return d.as((...t)=>y.equal(e,t)?r:void 0)}static as(t){if(t instanceof d)return t;if("function"!=typeof t){const e=t;t=()=>e}const e=(...e)=>t(...e);return Object.setPrototypeOf(e,d.prototype),e.what=t.bind(e),e}static retype(t,e){return Object.setPrototypeOf(t,Object.getPrototypeOf(e)),t}if(t=t=>void 0!==t,e=void 0){return d.retype(d.if(t,this,e),this)}static if(t,e,r=void 0){return d.as((...s)=>{if(t(...s))return e(...s);if(void 0!==r)throw r})}sthen(t){return d.retype(d.sthen(this,t),this)}static sthen(...t){return d.as(e=>{let r=e;for(let e of t)r=e(r);return r})}else(t,e){return t=d.as(t),d.retype((...r)=>{let s;try{s=this(...r)}catch(s){if(!e||l.matches(s,e))return t(...r,s);throw s}return void 0===s?t(...r):s},this)}which(t=t=>void 0!==t,e=d.WHICH_ERROR){return d.retype(d.which(this,t,e),this)}static which(t,e=t=>void 0!==t,r=void 0){return d.as((...s)=>{const n=t(...s);if(e(n,...s))return n;if(void 0!==r)throw r})}when(t,e,r,s=void 0,n=!0){return f.when(t,this,e,r,s,n)}match(...t){return d.retype(d.match(this,...t),this)}static match(...t){const e=t.length<2?e=>[e,t[0](e)]:e=>t.map(t=>t(e));return d.as(e)}each(t){return d.retype((...e)=>y.as(this(...e)).which().sthen(t).which().else(),this)}static each(...t){return d.as(e=>{const r=e instanceof h?e:h.of(e);return r.length>t.length?y.of():r.across(y.as(d.as(t[r.length-1])(r.last)).which()).which()})}self(...t){return d.retype(d.self(this,...t),this)}static self(t,...e){let r;if(0===e.length)return r=e=>e.across(y.as(t(e.last)).which().toArray()),d.as(r);if("number"!=typeof e[0]){const[r,s]=e;return d.nominal(t,r,s)}if(2===e.length){const[r,s]=e;return d.partial(t,r,s)}return f.self(t,...e)}static partial(t,e,r){return d.as((...s)=>t(...s.slice(0,e),r,...s.slice(e)))}static nominal(t,e,r){let s;return s=void 0===e?(...e)=>{const s=t(...e);if(void 0===s)return;const n={};return n[r]=s,n}:s=>{const n=y.as("string"==typeof e?[e]:e).sthen(t=>"string"==typeof t?s[t]:t).toArray(),i=("string"==typeof t?s[t]:t)(...n);return void 0!==r?(s[r]=i,s):i},d.as(s)}}class y{[Symbol.iterator](){throw"abstract method!"}static as(t){if(void 0===t)return y.of();if(t instanceof y)return t;if(t[Symbol.iterator]){const e=new y;return e[Symbol.iterator]=t[Symbol.iterator].bind(t),e}{const e=new y;return e[Symbol.iterator]=function*(){yield t},e}}static of(...t){const e=new y;return e[Symbol.iterator]=function*(){for(const e of t)yield e},e}static along(t,e){const r=new y;return r[Symbol.iterator]=function*(){let r=t;for(;r;)yield r,r=e(r)},r}toArray(){return Array.from(this)}equals(t){return y.equal(this,t)}static equal(t,e){if("string"==typeof t||!y.isIterable(t)||"string"==typeof e||!y.isIterable(e))return t===e;{const r=t[Symbol.iterator](),s=e[Symbol.iterator]();for(;;){const t=r.next(),e=s.next();if(t.done||e.done)return t.done===e.done;if(!y.equal(t.value,e.value))return!1}}}static isIterable(t){return null!=t&&"function"==typeof t[Symbol.iterator]}if(t=t=>void 0!==t){return y.if(this,t)}static if(t,e=t=>void 0!==t){return y.which(t,e)}sthen(t){return y.sthen(this,t)}static sthen(t,e){const r=new y;return r[Symbol.iterator]=function*(){let r=0;for(let s of t)yield e(s,r++)},r}else(t=void 0){return void 0===t?y.else(this):y.else(y.of(this,y.as(t)))}static else(t){const e=new y;return e[Symbol.iterator]=function*(){for(let e of t)if(e[Symbol.iterator])for(let t of e)yield t;else yield e},e}which(t=t=>void 0!==t){return y.which(this,t)}static which(t,e=t=>void 0!==t){const r=new y;return r[Symbol.iterator]=function*(){let r=0;for(let s of t)e(s,r++)&&(yield s)},r}when(t,e=!0,r=e){return y.when(this,t,e,r)}static when(t,e,r=!0,s=r){if(void 0===e){const e={};return e[Symbol.asyncIterator]=async function*(){for(const e of t)yield await e},u.as(e)}if("number"==typeof e){const t=e;e=(e,r)=>r===t}const n=new y;return n[Symbol.iterator]=r?function*(){let r=0,n=!1;for(let i of t)n?yield i:e(i,r)&&(n=!0,s&&(yield i)),r++}:function*(){let r=0,n=!1;for(let i of t){if(n)break;e(i,r)?(n=!0,s&&(yield i)):yield i,r++}},n}match(t=void 0){return void 0===t?y.match(...this):y.match(this,y.as(t))}static match(...t){const e=new y;return e[Symbol.iterator]=function*(){const e=t.map(t=>t[Symbol.iterator]());for(;;){const t=e.map(t=>t.next());if(t.some(t=>t.done))break;yield t.map(t=>t.value)}},e}each(t=void 0){if(void 0===t)return y.each(...this);const e=this,r=new y;return r[Symbol.iterator]=function*(){for(let r of e)for(let e of y.as(t))yield[r,e]},r}static each(...t){return t=t.map(t=>t[Symbol.iterator]?t:[t]),d.as(e=>e.length<t.length?e.across(t[e.length]):y.of())}self(){return y.self(this)}static self(t){const e=new y;return e[Symbol.iterator]=function*(){for(;;)yield t},e}what(t=void 0,e=void 0){return y.what(this,t,e)}static what(t,e,r){if(e){void 0===r&&(r=y.what(t),t=y.when(t,1));for(let s of t)r=e(r,s);return r}for(let e of t)return e}}y.NATURAL=new y,y.NATURAL[Symbol.iterator]=function*(){let t=0;for(;;)yield t++};class m extends i{_what;constructor(t,e=1/0,r=100,s=2,n=1/0){if(super(),"function"!=typeof t)throw new TypeError("Ostinato requires a function as the refrain.");this._what=f.as(t).self(e,r,s,n)}play(){return this._what?.stopped&&(this._what.stopped=!1),this._what?.(),super.play(),this}pause(){return this._what&&(this._what.stopped=!0),super.pause(),this}}class w extends i{constructor(t,e,r=void 0){super(),this.time=t,this.eventName=e,this.payload=r,this.timeout=void 0}get remaining(){return Math.max(0,this.time-Date.now())}isPending(){return Date.now()<this.time}play(){return!this.playing&&this.isPending()&&(this.timeout=setTimeout(()=>this.fire(),this.remaining),super.play()),this}pause(){return this.playing&&(clearTimeout(this.timeout),this.timeout=void 0,super.pause()),this}fire(){this.emit(this.eventName,this.payload??this),this.pause(),this.ensemble?.remove(this.name)}}class g extends o{constructor(){super(),this.add("cues",new o).add("ostinatos",new o).add("agenda",new o)}get cues(){return this.get("cues")}get ostinatos(){return this.get("ostinatos")}get agenda(){return this.get("agenda")}cue(t,e,r,s,n){return this.cues.add(t,new a(e,r,s,n)),this}ostinato(t,e,r=1/0,s=1e3,n=1,i=1/0){return this.ostinatos.add(t,new m(e,r,s,n,i)),this}appointment(t,e,r,s){return this.agenda.add(t,new w(e,r,s)),this}}class v extends g{constructor(){super()}get sprite(){return this.ensemble?.ensemble}}class b{static json(t,e,r,s,n="response"){t.statusCode=e,t.setHeader("Content-Type","application/json"),t.end(JSON.stringify(r)),s?.emit&&s.emit(n,{res:t,code:e,body:r})}static redirect(t,e){t.headersSent||t.writableEnded||(t.statusCode=302,t.setHeader("Location",e),t.end())}static end(t,e,r){return t.statusCode=e,t.end(r)}}class _{static async prepareBody(t,e){if(t.body)return!0;const r=await _.getBody(t);return r&&(t.body=r),!!r}static prepareQuery(t){return t.query||(t.query=_.getQuery(t)),!0}static prepareCookies(t){return t.cookies||(t.cookies=_.getCookies(t)),!0}static prepareToken(t,e={cookie:"token",header:"Authorization",query:"token"}){return t.token||(t.token=this.getToken(t,e)),!!t.token}static prepareURL(t){return t.URL||(t.URL=this.getURL(t)),!!t.URL}static getURL(t){const e=`http://${t.headers.host||"localhost"}`,r=new URL(t.url,e);return r.pathname=k.normalize(r.pathname),r}static async getBody(t){if(t.body)return t.body;if(!["POST","PUT","PATCH"].includes(t.method))return;let e="";if(t.on)for await(const r of t)e+=r;const r=(t.headers?.["content-type"]||"").toLowerCase();if(r.includes("application/json"))return JSON.parse(e);if(r.includes("application/x-www-form-urlencoded")){const t=new URLSearchParams(e.trim());return Object.fromEntries(t.entries())}return e}static getCookies(t){if(t.cookies)return t.cookies;const e=t?.headers?.cookie;return e?Object.fromEntries(e.split(";").map(t=>t.split("=").map(t=>t.trim())).filter(([t,e])=>t&&e).map(([t,e])=>[t,decodeURIComponent(e)])):{}}static getQuery(t){if(t.query)return t.query;try{const e=new URL(t?.url||"","http://localhost");return Object.fromEntries(e.searchParams.entries())}catch{return{}}}static getToken(t,e={cookie:"token",header:"Authorization",query:"token"}){const r=_.getCookies(t);if(r&&r[e.cookie])return r[e.cookie];const s=t?.headers?.[e.header?.toLowerCase()];if(s){const t=s.split(" ");return 2===t.length&&/^Bearer$/i.test(t[0])?t[1]:s}const n=_.getQuery(t);return n&&n[e.query]?n[e.query]:void 0}static enforceMethod(t,e,r){const s=Array.isArray(t)?t.map(t=>t.toUpperCase()):t.split(/(?:,|\s)+/).map(t=>t.trim().toUpperCase()).filter(Boolean),n=e.method.toUpperCase();return!!s.includes(n)||(r.setHeader("Allow",s.join(", ")),b.json(r,405,{success:!1,error:"Method Not Allowed"}),!1)}static queryString(t){const e=new URLSearchParams;return t.forEach(([t,r])=>e.append(t,r)),e.toString()}static args(t={},...e){return e.map(e=>t[e])}}class k{static normalize(t){if("string"!=typeof t||!t.trim())return"/";try{let e=decodeURIComponent(t).replace(/\/{2,}/g,"/");return e.startsWith("/")||(e="/"+e),e.length>1&&e.endsWith("/")&&(e=e.slice(0,-1)),e||"/"}catch{return"/"}}static isBase(t,e){return"/"===t||t===e||e.startsWith(t+"/")}static*subpaths(t){if("/"===(t=t.trim()))return void(yield t);const e=t.startsWith("/")?"/":"",r=t.split("/");let s;for(let t of r)s=s?s+"/"+t:t,yield e+s}static route(t,e,r,s){const n=e.toUpperCase();if(t&&"function"==typeof t[n.toLowerCase()])t[n.toLowerCase()](r,async(t,e,r)=>{try{await s(t,e)}catch(t){r(t)}});else if(t&&"function"==typeof t.route)t.route({method:n,url:r,handler:s});else if(t&&"function"==typeof t.use&&Array.isArray(t.middleware))t.use(async(t,e)=>{if(t.method.toUpperCase()===n&&t.path===r)try{await s(t.req,t.res),t.respond=!1}catch(e){t.status=500,t.body={error:e.message}}else await e()});else{if(!t||"function"!=typeof t.on)throw new Error("Unsupported application framework");t.on("request",async(t,e)=>{const i=new URL(t.url,`http://${t.headers.host}`).pathname;if(t.method.toUpperCase()===n&&i===r)try{await _.prepare(t,e),await s(t,e)}catch(t){e.statusCode=500,e.end(t.message)}})}}static get(t,e){e=k.keys(e);let r=t;for(const t of e){if(null==r||!(t in r))return;r=r[t]}return r}static set(t,e,r,s=!1){if(!(e=k.keys(e)).length)throw new Error("Invalid path: empty keys");let n=t,i=0;for(const t of e.slice(0,-1)){if(!(t in n)){if(!s)throw new Error(`nonexistent path: ${e.slice(0,i+1).join(".")}`);n[t]={}}n=n[t],i++}n[e[e.length-1]]=r}static delete(t,e){e=k.keys(e),delete k.get(t,e.slice(0,-1))[e[e.length-1]]}static keys(t){return"string"==typeof t?t.split(".").filter(Boolean):[...t]}static isAncestor(t,e){const r=k.keys(t),s=k.keys(e);if(r.length>s.length)return!1;for(let t=0;t<r.length;t++)if(r[t]!==s[t])return!1;return!0}}class L extends f{static metaCtx="_hMeta";static as(t=t=>t,e=L.prototype){const r=f.as(t);return Object.setPrototypeOf(r,e),r}checking(t,e=async t=>!!t,r){return this.if(async r=>await e(L.ctx(r,t)),r)}check(t,e=async t=>!!t,r){return this.which(async r=>await e(L.ctx(r,t)),r)}setting(t,e,r=!0,s){return this.if(async n=>await L.doSet(n,t,e,r,s))}set(t,e,r=!0,s){return this.which(async n=>await L.doSet(n,t,e,r,s))}static async doSet(t,e,r,s=!0,n){try{const n=L.currentCtx(t),i="function"==typeof r?await r(n):await r;if(void 0===i)throw new Error("undefined result");return k.set(n,e,i,s),t}catch(t){throw n.clone?.(t)||n||t}}with(t,e=!0,r){return this.sthen(async s=>{let n=await k.get(s,L.metaCtx);n||(n=[],k.set(s,L.metaCtx,n));const i=n[n.length-1]||s;let o=k.get(i,t);if(void 0===o){if(!e)throw r;o={},k.set(i,t,o,!0)}return n.push(o),s})}without(t=1){return this.sthen(async e=>{let r=await k.get(e,L.metaCtx);if(Array.isArray(r)&&r.length>0){const s=Math.min(r.length,t);r.splice(r.length-s,s),r.length||k.delete(e,L.metaCtx)}return e})}static currentCtx(t){const e=k.get(t,L.metaCtx);return e?.at(-1)??t}static ctx(t,e){const r=L.currentCtx(t);return k.get(r,e)}}class S extends Error{constructor(t,e,r){super(t),this.name=this.constructor.name,this.path=e,r&&(this.cause=r)}clone(t){throw new Error("abstract method: subclasses must implement clone(cause)")}}class E extends S{constructor(t,e,r,s){super(e,r,s),this.statusCode=t}clone(t){return new E(this.statusCode,this.message,this.path,t)}}class O extends L{static as(t=t=>t){const e=L.as(t);return Object.setPrototypeOf(e,O.prototype),e}preparingBody(t=new E(422,"invalid or malformed JSON body")){return this.checking("req",async t=>await _.prepareBody(t),t)}prepareBody(t=new E(422,"invalid or malformed JSON body")){return this.check("req",async t=>await _.prepareBody(t),t)}preparingURL(){return this.checking("req",_.prepareURL)}prepareURL(){return this.check("req",_.prepareURL)}preparingQuery(){return this.checking("req",t=>_.prepareQuery(t))}prepareQuery(){return this.check("req",t=>_.prepareQuery(t))}preparingCookies(){return this.checking("req",t=>_.prepareCookies(t))}prepareCookies(){return this.check("req",t=>_.prepareCookies(t))}preparingToken(t=new E(401,"missing authentication token")){return this.checking("req",t=>_.prepareToken(t),t)}prepareToken(t=new E(401,"missing authentication token")){return this.check("req",t=>_.prepareToken(t),t)}checkingMethod(t,e=new E(405,"Invalid HTTP method")){return this.checking("req.method",e=>"string"==typeof e&&e===t,e)}checkMethod(t,e=new E(405,"Invalid HTTP method")){return this.check("req.method",e=>"string"==typeof e&&e===t,e)}checkingAccept(t,e=new E(406,"Not Acceptable")){return this.checking("req.headers.accept",e=>"string"==typeof e&&e.includes(t),e)}checkAccept(t,e=new E(406,"Not Acceptable")){return this.check("req.headers.accept",e=>"string"==typeof e&&e.includes(t),e)}checkingContentType(t,e=new E(400,"Invalid Content-Type")){return this.checking("req.headers.content-type",e=>"string"==typeof e&&e.includes(t),e)}checkContentType(t,e=new E(400,"Invalid Content-Type")){return this.check("req.headers.content-type",e=>"string"==typeof e&&e.includes(t),e)}}class A extends y{constructor(){super()}n(){throw new Error("Abstract method: n()")}has(t){throw new Error("Abstract method: has(item)")}add(t){throw new Error("Abstract method: add(item)")}remove(t){throw new Error("Abstract method: remove(item)")}clear(){throw new Error("Abstract method: clear()")}get(t){throw new Error("Abstract method: get(query)")}[Symbol.iterator](){throw new Error("Abstract method: Symbol.iterator()")}create(t){return!this.has(t)&&this.add(t)}read(t){return this.has(t)?y.as(this.get(t)).what():void 0}readAll(t){return this.get(t)}update(t,e,r=!1){return this.has(t)?this.remove(t)&&this.add(e):!!r&&this.add(e)}delete(t){return this.remove(t)}deleteAll(t){return this.removeAll(t)}query(t){return this.get(t)}isEmpty(){return 0===this.n()}let(t){return this.add(t),this}addAll(t){const e=[];for(const r of t)this.add(r)&&e.push(r);return this}removeAll(t){const e=[];for(const r of t)this.remove(r)&&e.push(r);return e}}Symbol.asyncIterator;class j extends A{constructor(){super()}peek(t=!0){throw new Error("Abstract method: peek() must be implemented by subclass.")}poll(t=!0){throw new Error("Abstract method: poll() must be implemented by subclass.")}reverse(){throw new Error("Abstract method: reverse() must be implemented by subclass.")}select(t,e=!0){t<0&&(t=0);const r=this.n()-t,s=new Array(r<0?0:r).fill(void 0);let n=e?s.length-1:0;const i=e?-1:1;for(;this.n()>t;){const t=this.poll(!e);s[n]=t,n+=i}return s}}class C extends j{constructor(t=!0,e=[]){super(),this._fifo=t,this._items=e}get fifo(){return this._fifo}get items(){return this._items}n(){return this.items.length}has(t){return!1}add(t){return this.items.push(t),!0}remove(t){return!1}peek(t=!0){return this.items[this.index(t)]}poll(t=!0){return 0===this.index(t)?this.items.shift():this.items.pop()}index(t){return this.fifo?t?0:this.items.length-1:t?this.items.length-1:0}clear(){return this.items.length=0,!0}[Symbol.iterator](){return this.items[Symbol.iterator]()}reverse(){const t=new y,e=this;return t[Symbol.iterator]=function*(){let t=e.items.length-1;for(;t>=0;)yield e.items[t],t--},t}}const x=(t,e)=>(t?.value??t)-(e?.value??e),I=(t,e)=>(e?.value??e)-(t?.value??t);class q extends C{constructor(t=x,e=[]){super(!0,[]),this._comparator=t,this._items=[];for(const t of e)this.add(t)}get items(){return this._items}get comparator(){return this._comparator}has(t){const[e,r]=q.logSearch(t,this.items,this.comparator);return void 0!==r}add(t){const[e,r]=q.logSearch(t,this.items,this.comparator);return void 0===r&&(this.items.splice(e,0,t),!0)}remove(t){const[e,r]=q.logSearch(t,this.items,this.comparator);return void 0!==r&&(this.items.splice(e,1),!0)}static logSearch(t,e,r,s=0,n=e.length){for(;s<n;){const i=s+n>>>1,o=r(e[i],t);if(0===o)return[i,e[i]];o<0?s=i+1:n=i}return[s,void 0]}}class T extends g{id;opts;constructor(t,e={connectivity:20,beat:2e4}){super(),this.id=t,this.opts=e,this.add("auras",new o),this.add("vibes",new o);const r=AsyncWhat.as(this.refreshVibes.bind(this)).self(2e3).else(t=>this.notify(t));this.ostinato("refreshVibes",r,1/0,this.opts.beat,1).cue("closeCue",this,"close",this.onClose.bind(this))}get node(){return this.ensemble?.ensemble}get auras(){return this.get("auras")}get vibes(){return this.get("vibes")}async refreshVibes(){const t=Date.now();for(const e of Each.as(this.vibes).which(e=>!e.isActive(this.opts.beat,t)))e.primo.close(1e3,"inactive socket");if(this.opts.connectivity<this.vibes.players.size){const t=new q(I).letAll(this.vibes).select(this.opts.connectivity);for(const e of t)e.mute()}}notify(t){this.emit("error",t,this),console.error(t)}onClose(...t){const e=t.at(-1);e&&this.vibes.remove(e.name)}send(t,e=()=>!0,r=new Error("Selected Vibe does not satisfy predicate")){const s=this.vibes.rotate();if(s.muted)throw new Error("Selected Vibe is muted");if(!e(s))throw r;return s.primo.send(t),!0}static id(t,e){return`${t}:${e}`}static parseId(t){const[e,r]=t.split(":");return{user:e,name:r}}static isConnectedTo(t,e){const{user:r,name:s}=T.parseId(e);for(const t of this.vibes.players){const{user:e,name:n}=T.parseId(t.name);if(r===e&&(!s||s===n))return!0}return!1}}class P extends g{httpServer;urls;users;sprites;vibes;constructor(t,e={img:"/gaia/img"},r={},s={},n={}){super(),this.httpServer=t,this.urls=Object.fromEntries(Object.entries(e).map(([t,e])=>[t,k.normalize(e)])),this.users=r,this.sprites=s,this.vibes=n,this.cue(t,"request",this.handleRequest.bind(this))}async handleRequest(t,e){k.normalize(t.url).startsWith(this.urls.img)&&await this.handleImgRequest(t,e)}async handleImgRequest(t,e){await O.as(this.resolveImgRequest.bind(this)).checkingMethod("POST").checkingAccept("application/json").preparingBody().preparingQuery().else(({_:t,res:e},r)=>b.json(e,400,{error:r?.message??"Bad request"})).what({req:t,res:e})}async resolveImgRequest({req:t,res:e}){try{P.update(this.img,t.body??{});const[r,s,n,i]=[t.query.long,t.query.lat,t.query.radius??1/0,t.query.sample??1/0].map(Number),o=t.query.targets?.split(/[\s,]+/),a=t.query.requireUrl&&"false"!==t.query.requireUrl.trim(),c=this.img([r,s],n,i,a,o);e.json(c)}catch(t){this.notify("error",t),e.statusCode=500,e.json({error:t.message||"Internal server error"})}}static update(t,{users:e={},sprites:r={},vibes:s={}}={}){if(!t||"object"!=typeof t)throw new TypeError("Gaia.update() requires a valid image object as first argument");return e&&"object"==typeof e&&Object.assign(t.users,e),r&&"object"==typeof r&&Object.assign(t.sprites,r),s&&"object"==typeof s&&Object.assign(t.vibes,s),t}img([t,e]=[],r=1/0,s=1/0,n=!1,i=void 0){let o;o=Number.isFinite(t)&&Number.isFinite(e)&&Number.isFinite(r)?Object.entries(this.sprites).filter(([,s])=>P.dist([t,e],[s.long,s.lat])<r):Object.entries(this.sprites),n&&(o=o.filter(([t,e])=>e.url)),Array.isArray(i)&&i.length>0&&(o=o.filter(([t,e])=>(this.vibes[t]||[]).some(t=>{const{user:e}=T.parseId(t);return i.includes(t)||i.includes(e)})));const a=Object.fromEntries(P.sample(o,s)),c=new Set(Object.keys(a)),h=Object.fromEntries(Object.entries(this.vibes).filter(([t])=>c.has(t))),u=new Set([...Object.keys(a).map(t=>T.parseId(t).user),...Object.values(h).flat().map(t=>{const{user:e}=T.parseId(t);return e})]);return{users:Object.fromEntries([...u].filter(t=>this.users[t]).map(t=>[t,this.users[t]])),sprites:a,vibes:h}}static sample(t,e){if(t.length<=e)return y.as(t);const r=new y;return r[Symbol.iterator]=function*(){for(let r=0;r<e;r++){const e=Math.floor(Math.random()*t.length);yield t[e]}},r}static dist([t,e],[r,s]){const n=e*Math.PI/180,i=s*Math.PI/180,o=(s-e)*Math.PI/180,a=(r-t)*Math.PI/180,c=Math.sin(o/2)**2+Math.cos(n)*Math.cos(i)*Math.sin(a/2)**2;return 2*Math.atan2(Math.sqrt(c),Math.sqrt(1-c))*6371e3}static servers(t){return y.as(Object.keys(t.sprites)).which(e=>t.sprites[e].url)}static imgQuery([t,e],r,s,n,...i){const o={long:t,lat:e,radius:r,sample:s,requireUrl:n};return i.length>0&&(o.targets=i.filter(Boolean).join(",")),Object.entries(o).filter(([t,e])=>void 0!==e).map(([t,e])=>`${t}=${encodeURIComponent(e)}`).join("&")}}class R extends g{constructor(t,e={}){super(),this.primo=t,this.opts={...e}}}class U extends R{events;_cues;constructor(t,e,r={}){super(t,r),this.events=[...e],this._cues=Object.freeze(e.map(e=>new a(t,e,this.propagate.bind(this,e),this.opts)))}get cues(){return this._cues}play(){return this.playing||(this.cues.forEach(t=>t.play()),super.play()),this}pause(){return this.playing?(this.cues.forEach(t=>t.pause()),super.pause(),this):this}propagate(t,...e){return this.emit(t,...e,this),this}}class M extends U{constructor(t,e=0,r=Date.now(),s=!1){super(t,["message","error","close"]),this.value=e,this.lastActive=r,this.muted=s,this.lastPing=1/0,this.cue("messageCue",this,"message",t=>{const e=M.json(t);this.lastActive=Date.now(),"ping"===e.type&&!e.payload&&e.pingId&&this.pong(void 0,e.pingId)})}touch(){this.lastActive=Date.now()}isActive(t=6e4,e=Date.now()){return this.lastActive+t>=e}mute(){this.muted=!0}async ping(t=void 0,e=2e3){const r=performance.now(),s=crypto.randomUUID(),n=AsyncWhat.as(()=>this.ws.send(JSON.stringify({type:"ping",id:s,payload:t}))),i=AsyncWhat.as(()=>this.eval(r));await n.sthen(i.when((t,e)=>{const r=M.json(e);return"pong"===r.type&&r.pingId===s},this.ws,"message",e)).else(()=>this.value=-1/0).what()}eval(t){const e=performance.now()-t;this.value=-e}pong(t,e=void 0){this.ws.send(JSON.stringify({type:"pong",pingId:t,payload:e}))}static json(t){if("string"==typeof t)return JSON.parse(t)}}class N extends v{constructor(t,e,r=()=>!0){super(),this.opts=t,this.wsConstructor=e,this.serverFilter=r,this.gaiaImg=void 0;const s=AsyncWhat.as(this.refreshGaiaImg.bind(this)).self(5e3).else(t=>this.notify("error",t)),n=AsyncWhat.as(this.feedVibes.bind(this)).self(2e3).else(t=>this.notify("error",t));this.ostinato("refreshGaiaImg",s,1/0,this.opts.gaia.beat,1).ostinato("feedVibes",n,1/0,this.opts.vibe.beat,1)}get token(){return this.sprite?.node?.token}get payload(){return this.gaiaImg?.sprites?.[this.target.id]}get img(){return{users:Object.fromEntries([this.sprite.node.user.id,this.sprite.node.user]),sprites:Object.fromEntries([[this.target.id,this.payload]]),vibes:Object.fromEntries([[this.target.id,Array.from(Object.keys(this.target.vibes))]])}}async refreshGaiaImg(){if(!this.token)return void this.notify("warning","No token available from owning Node");const t=await this.fetchGaiaImg([],1/0,1/0);this.gaiaImg=t}async fetchGaiaImg([t,e],r,s=this.opts.gaia.sample,n=this.opts.gaia.requireUrl,i=this.opts.gaia.targets){const o=this.token;if(!o)throw new Error("Missing authentication token");const a=await fetch(`${this.opts.gaia.url}?${Gaia.imgQuery([t,e],r,s,n,...i)}`,{method:"POST",headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"},body:JSON.stringify(this.img)});if(!a.ok)throw new Error(`Gaia fetch failed: HTTP ${a.status} ${a.statusText}`);return a.json()}async feedVibes(){if(this.opts.gaia.sample<=0)return;if(!this.token)return void this.notify("warning","Cannot feed vibes — missing token from Node");const{long:t,lat:e}={long:this.payload.long,lat:this.payload.lat},r=await this.fetchGaiaImg([t,e],this.opts.gaia.radius??1/0,this.opts.gaia.sample,this.opts.gaia.requireUrl,this.opts.gaia.targets),s=Object.keys(r.sprites).filter(this.serverFilter),n=[];for(const t of Gaia.sample(s,this.opts.gaia.sample)){const{url:e}=r.sprites[t];if(!e)continue;const s=new this.wsConstructor(e),i=new M(s);this.target.vibes.add(t,i),n.push(i.ping())}await Promise.all(n)}}class $ extends v{constructor(t,e=()=>!0){super(),this.wsServer=t,this.filter=e,this.cue("connectionCue",t,"connection",this.handleConnection.bind(this))}async handleConnection(t,e){await O.as(this.resolveConnection.bind(this)).preparingToken().else(()=>this.notify("warning","Missing or invalid token in connection request")).what({req:e,ws:t})}async resolveConnection({req:t,ws:e}){if(!this.filter(t))return void this.notify("info",`Connection filtered out: ${t.url}`);if(!t.token||!t.token.id)return void this.notify("warning","Missing Sprite ID in token payload");const r=new M(e);this.sprite.vibes.add(t.token.id,r),this.notify("info",`✨ HttpAura added new Vibe from Sprite ${t.token.id} to Sprite ${this.sprite.id}`)}}return s})());